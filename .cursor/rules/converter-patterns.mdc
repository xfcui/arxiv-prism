---
description: Patterns for HTML/XML to JSON/Markdown conversion
globs: "**/*.py"
alwaysApply: false
---

# Converter Patterns

## HTML Extraction (Nature/Springer journals)
- Title: `h1.c-article-title`
- DOI: `meta[name="DOI"]` or `window.dataLayer` JSON
- Journal: `meta[name="citation_journal_title"]`
- Date: `meta[name="citation_publication_date"]`
- Keywords: `meta[name="citation_keywords"]`
- Authors: `ul.c-article-author-list` → `a[data-test="author-name"]`
- Affiliations: Elements with `id="Aff1"`, `id="Aff2"`, etc.
- Abstract: `section[data-title="Abstract"]`
- Sections (level 1-3): `section[data-title]`, `h2`, `h3`, `h4`

## XML Extraction (PubMed Central JATS)
- Title: `article-title`
- DOI: `article-id[pub-id-type="doi"]`
- Journal: `journal-title`
- Date: `pub-date` → `year`, `month`, `day`
- Keywords: `kwd-group` → `kwd`
- Authors: `contrib[contrib-type="author"]` → `surname`, `given-names`
- Affiliations: `aff[id]` with `label` and text
- Abstract: `abstract`
- Sections (level 1-3): `sec[disp-level="1|2|3"]` with nested `title`

## Error Handling
- Warn and continue on missing/malformed elements
- Use logging with configurable verbosity
- Missing optional fields → None or empty list

## Intermediate Representation
```python
# Recursive Section structure for arbitrary nesting
class Section:
    title: str
    level: int           # 1=section, 2=subsection, 3=subsubsection
    content: str         # Text before any child sections
    children: list[Section]  # Nested subsections

class Article:
    title: str
    authors: list[Author]
    affiliations: list[Affiliation]
    abstract: str
    sections: list[Section]  # Top-level sections only
    figures: list[Figure]
    tables: list[Table]
    supplementary: list[Supplementary]  # {"label": str, "description": str}
    # Math in-place, citations removed, URLs as markdown
```

## Special Content Handling
- **Figures**: Full block with `**Figure X**: caption` and `*(image omitted)*`
- **Tables**: Convert to Markdown table with `| col | col |` format
- **Inline formulas**: Convert MathML to LaTeX, keep in-place as `$latex$`
- **Display formulas**: Convert MathML to LaTeX, keep in-place as `$$latex$$`

## Table Extraction
- HTML: `<table>` with `<thead>`, `<tbody>`, `<tr>`, `<th>`, `<td>`
- XML: `<table-wrap>` containing `<table>` with similar structure
- Store as `list[list[str]]` where first row is header

## Other Non-Text Elements
- **Citations**: Remove inline markers `[1]`, `[1,2]`, superscripts
- **Reference list**: Skip entirely
- **URLs**: Convert to markdown `[text](url)`
- **Supplementary**: List at end with label and description
- **Cross-refs**: Convert to plain text ("Figure 1", "Section 2.1")
